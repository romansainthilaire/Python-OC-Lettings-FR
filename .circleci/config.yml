version: 2.1

jobs:
  build:
    working_directory: /code
    docker:
      - image: docker:20.10.9
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: |
            docker-compose build
      - run:
          name: Start Docker containers
          command: |
            docker-compose up -d
      - run:
          name: Install dependencies
          command: |
            docker-compose exec web python -m venv venv
            docker-compose exec web source venv/bin/activate
            docker-compose exec web pip install -r requirements.txt
      - run:
          name: Run Pytest
          command: |
            docker-compose exec web pytest
      - run:
          name: Stop Docker containers
          command: |
            docker-compose down
  deploy:
    docker:
      - image: docker:20.10.9
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Heroku CLI
          command: |
            curl https://cli-assets.heroku.com/install.sh | sh
      - run:
          name: Login to Heroku
          command: |
            echo "$HEROKU_API_KEY" | docker login --username=_ --password-stdin registry.heroku.com
            heroku container:login
      - run:
          name: Push Docker image to Heroku
          command: |
            docker-compose -f docker-compose.heroku.yml build
            docker tag oc-lettings-site_web:latest registry.heroku.com/$HEROKU_APP_NAME/web
            docker push registry.heroku.com/$HEROKU_APP_NAME/web
      - run:
          name: Release the Docker image
          command: |
            heroku container:release web -a $HEROKU_APP_NAME
